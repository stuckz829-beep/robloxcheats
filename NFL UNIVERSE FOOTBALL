-- SECURE MODE: Essential for Rayfield to load in 2026 without crashing
getgenv().SecureMode = true 

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

if not Rayfield then 
    warn("RAYFIELD FAILED TO LOAD: Try re-executing or check your executor.")
    return 
end

local Window = Rayfield:CreateWindow({
   Name = "Football Pro V13",
   LoadingTitle = "NFL UNIVERSE FOOTBALL Hub",
   LoadingSubtitle = "by unknown",
   ConfigurationSaving = { Enabled = true, FolderName = "HeadConfigs", FileName = "Main" },
   KeySystem = false,
})

-- Logic Variables
local MaggingEnabled = false
local MagPower = 1 
local HeadHopEnabled = false
local BounceHeight = 1
local BounceCooldown = 2 -- UPDATED: Cooldown set to 2 seconds
local LastBounce = 0.2
local ExpandEnabled = false
local HeadSize = 1
local TargetGravity = 196.2 
local DefaultGravity = 196.2
local MagVisual = nil

-- Performance Optimization: Cache Variables
local lp = game.Players.LocalPlayer
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Character = lp.Character or lp.CharacterAdded:Wait()
local Root = Character:WaitForChild("HumanoidRootPart")
local TotalMass = 0

-- Function to update mass (only runs when character changes, saving FPS)
local function UpdateMass()
    Character = lp.Character
    if not Character then return end
    Root = Character:FindFirstChild("HumanoidRootPart")
    TotalMass = 0
    for _, part in pairs(Character:GetChildren()) do 
        if part:IsA("BasePart") then TotalMass = TotalMass + part:GetMass() end 
    end
end
lp.CharacterAdded:Connect(UpdateMass)
UpdateMass()

local MainTab = Window:CreateTab("Main Hub", 4483362458) 

MainTab:CreateSection("Football Magging")
MainTab:CreateToggle({Name = "Enable Magging", CurrentValue = false, Flag = "MagToggle", Callback = function(Value) MaggingEnabled = Value end})
MainTab:CreateSlider({Name = "Magging Pull Range", Range = {1, 100}, Increment = 1, Suffix = " Speed", CurrentValue = 1, Flag = "MagSlider", Callback = function(Value) MagPower = Value end})

MainTab:CreateSection("Personal Physics")
MainTab:CreateSlider({Name = "WalkSpeed", Range = {18, 150}, Increment = 1, Suffix = " WalkSpeed", CurrentValue = 18, Flag = "Speed", Callback = function(Value)
      if Character and Character:FindFirstChild("Humanoid") then Character.Humanoid.WalkSpeed = Value end
end})
MainTab:CreateSlider({Name = "Player Gravity", Range = {30, 196.2}, Increment = 1, Suffix = " Gravity", CurrentValue = 196.2, Flag = "PlayerGravity", Callback = function(Value) TargetGravity = Value end})

MainTab:CreateSection("Head Bounce Settings")
MainTab:CreateToggle({Name = "Enable Boost Tech", CurrentValue = false, Flag = "HopToggle", Callback = function(Value) HeadHopEnabled = Value end})
MainTab:CreateSlider({Name = "Boost Height", Range = {1, 300}, Increment = 1, Suffix = " Studs", CurrentValue = 1, Flag = "HeightSlider", Callback = function(Value) BounceHeight = Value end})

MainTab:CreateSection("Head Expander (Others)")
MainTab:CreateToggle({Name = "Enable Head Size", CurrentValue = false, Flag = "ExpandToggle", Callback = function(Value) ExpandEnabled = Value end})
MainTab:CreateSlider({Name = "Head Size", Range = {1, 20}, Increment = 1, Suffix = " Studs", CurrentValue = 1, Flag = "SizeSlider", Callback = function(Value) HeadSize = Value end})

-- Logic Helpers
local function findFootballInWorkspace()
    for _, v in pairs(workspace:GetChildren()) do -- Optimized search (Top-level only is faster)
        if v.Name == "Football" and v:IsA("BasePart") then return v end
    end
    return workspace:FindFirstChild("Football", true) -- Fallback to deep search
end

local function checkInventoryForFootball()
    return (Character and Character:FindFirstChild("Football")) or lp.Backpack:FindFirstChild("Football")
end

-- MAIN ENGINE: Optimized Loop
RunService.RenderStepped:Connect(function()
    if not Character or not Root then return end
    local now = tick()

    -- Optimized Gravity: Avoid constant Instance.new in loop
    local forceObj = Root:FindFirstChild("GravityForce")
    if not forceObj then
        forceObj = Instance.new("VectorForce")
        forceObj.Name = "GravityForce"
        local att = Instance.new("Attachment", Root)
        att.Name = "GravityAttachment"
        forceObj.Attachment0 = att
        forceObj.RelativeTo = Enum.ActuatorRelativeTo.World
        forceObj.Parent = Root
    end
    forceObj.Force = Vector3.new(0, TotalMass * (DefaultGravity - TargetGravity), 0)

    -- Optimized Magging
    local ball = findFootballInWorkspace()
    if MaggingEnabled and ball then
        if not MagVisual then
            MagVisual = Instance.new("Part")
            MagVisual.Shape, MagVisual.Color, MagVisual.Transparency = Enum.PartType.Ball, Color3.fromRGB(255,0,0), 0.65
            MagVisual.CanCollide, MagVisual.Anchored, MagVisual.Material, MagVisual.CastShadow = false, true, Enum.Material.ForceField, false
            MagVisual.Parent = workspace
        end
        MagVisual.Position, MagVisual.Size = ball.Position, Vector3.new(MagPower * 2, MagPower * 2, MagPower * 2)
        
        if UIS:IsMouseButtonPressed(Enum.UserInputType.MouseButton1) then
            local pullDir = (ball.Position - Root.Position).Unit
            Root.AssemblyLinearVelocity = pullDir * math.clamp(MagPower * 2, 20, 130)
        end
    elseif MagVisual then 
        MagVisual:Destroy() 
        MagVisual = nil 
    end

    -- Optimized Head Expander (Runs checks only if enabled)
    if ExpandEnabled then
        for _, player in pairs(game.Players:GetPlayers()) do
            if player ~= lp and player.Character then
                local head = player.Character:FindFirstChild("Head")
                if head then
                    head.Size = Vector3.new(HeadSize, HeadSize, HeadSize)
                    head.Transparency = 0.5 
                    head.CanCollide = false -- Improved performance over raycasting every frame
                end
            end
        end
    end

    -- Optimized Head Bounce
    if HeadHopEnabled and not checkInventoryForFootball() and (now - LastBounce >= BounceCooldown) then
        local rayParams = RaycastParams.new()
        rayParams.FilterDescendantsInstances = {Character}
        rayParams.FilterType = Enum.RaycastFilterType.Exclude
        
        local ray = workspace:Raycast(Root.Position, Vector3.new(0, -6, 0), rayParams)
        if ray and ray.Instance and ray.Instance.Name == "Head" then
            LastBounce = now
            Root.AssemblyLinearVelocity = Vector3.new(Root.AssemblyLinearVelocity.X, BounceHeight, Root.AssemblyLinearVelocity.Z)
        end
    end
end)
